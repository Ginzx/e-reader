@var head = {
	<title>资源导入管理</title>
	<style>
	  .radius{border-radius:0;}
	</style>
@};
@var content = {
	<!-- <nav class="breadcrumb">
		<i class="Hui-iconfont">&#xe67f;</i> 首页 <span class="c-gray en">&gt;</span>资源导入管理 <span class="c-gray en">&gt;</span>元数据上传<span class="c-gray en">&gt;</span>
		<a class="btn btn-success radius r mr-20" style="line-height:1.6em;margin-top:3px" href="javascript:backToList();" title="返回" ><i class="Hui-iconfont" >&#xe678;</i></a>
	</nav> -->
	<div class="pd-20">
		<form action="${request.contextPath}/taskHandle/addBaseResInfo.html?taskId=${taskId}&siteId=${siteId}" method="post" class="form form-horizontal" id="createForm">
			<span class="l" style="margin:20px;">
				<div style="float: left;margin-right:10px;">
					数据类型：
					<input type="text" style="width:100px" id="dataType2" class="input-text" disabled="disabled" 
						@if(choiceType==1){
							value="epub"
						@}else if(choiceType==5){
							value="电子文稿 "
						@}else if(choiceType==6){
							value="图集 "
						@}else if(choiceType==3){
							value="音频 "
						@}else if(choiceType==4){
							value="视频 "
						@}else if(choiceType==2){
							value="txt"
						@}else if(choiceType==7){
							value="pdf书籍"
						@}
					>
					<!-- <span class="select-box" style="width:200px">
					<select class="select"  id="dataType2" size="1"  onchange="change()" disabled="disabled">
						<option value="6"
					    @if(choiceType==1){
					    	selected="selected"
					    @}
						>epub</option>
						<option value="1"
						 @if(choiceType==2){
					    	selected="selected"
					    @}
						>txt</option>
						<option value="4"
						 @if(choiceType==3){
					    	selected="selected"
					    @}
						>音频</option>
						<option value="5"
						 @if(choiceType==4){
					    	selected="selected"
					    @}
						>视频</option>
						<option value="3"
						 @if(choiceType==6){
					    	selected="selected"
					    @}
						>图集</option>
						<option value="2"
						 @if(choiceType==5){
					    	selected="selected"
					    @}
						>电子文稿</option>
						
					</select>
					</span> -->
				</div>
				<input type="hidden" id="resType" name="resType" value="${resType}"/>
				<input  type="hidden" id="dataType" name="dataType"
						@if(choiceType==1){
							value="6"
						@}else if(choiceType==2){
							value="1"
						@}else if(choiceType==6){
							value="3"
						@}else if(choiceType==3){
							value="4"
						@}else if(choiceType==4){
							value="5"
						@}else if(choiceType==5){
							value="2"
						@}else if(choiceType==7){
							value="7"
						@}
				
				>
				 <div style="float: left;margin-right:10px;">
					下载模板：
					<a href="javascript:;"onclick="downloadMoudle()" class="btn btn-primary radius"><i class="Hui-iconfont">&#xe63e;</i>下载元数据模板</a>
				</div> 
				<div  style="float: left;">
					<div class="uploader-thum-container">
							<label style="float: left;height:31px;line-height:31px;">上传元数据文件：</label>
							<div id="filePicker" class="webuploader-container">
								
								<div class="btn btn-primary radius"  >
									<i class="Hui-iconfont">&#xe642;</i>导入元数据
								</div>
								<div id="rt_rt_1agrit9p86a6102613rm2vu1gkr1" style="position: absolute; top: 0px; left: 0px; width:110px; height: 30px; overflow: hidden; bottom: auto; right: auto;">
									<input type="file" name="myfiles" id="baseRes" onchange="fileupload('baseRes')" class="" multiple="multiple" accept=".xls,.xlsx"  style="cursor:pointer;position:absolute;left: 0;top: 0;width:230px;height:130%;opacity:0;font-size:100px;"> 
								</div>
							</div>
							
					</div>
					<input type="hidden" value="" name="baseResPath" id="baseResPath"  > 
				</div>
			
			 	<div style="float: left;">
					<input type="text" value="" name="baseResPath2" id="baseResPath2" class="input-text" disabled="disabled"> 
				</div> 
				
				<div style="float: left; margin-left: 5px;">
					<input class="btn btn-primary radius" style="float: left;margin-right:5px;" id="start" type="button" value="&nbsp;&nbsp;开始执行&nbsp;&nbsp;">
					<button type="button" style="display: none;float: left;" id="errorBtn" class="btn btn-default" onclick="exportTable()"><i class="Hui-iconfont">&#xe665;</i> 导出查询结果</button>
				</div>
			</span>
		</form>
		<br>
		<br>
		<table id="myTable" class="table table-border table-bordered table-bg table-hover tablesorter">
			<thead>
				<tr class="text-c">
					<th width="10%">book_id</th>
					<th width="35%">资源名称</th>
					<th width="20%">执行结果</th>
					<th width="30%">失败原因</th>
				</tr>
			</thead>
			<tbody id="dataContent">
				
			</tbody>
		</table>
		
	</div>
@};
@var js = { 
	<script type="text/javascript" src="${request.contextPath}/lib/Validform/5.3.2/Validform.min.js"></script> 
	<script type="text/javascript" src="${request.contextPath}/lib/jquery.form.js"></script>
	<script type="text/javascript" src="${request.contextPath}/lib/table-export/tableToExcel.js"></script>
	<script type="text/javascript" src="${request.contextPath}/lib/table-export/jquery.table2excel.min.js"></script>
	<script>
		$(document).ready(function () {
			validSubmitFormAndRefreshParent('createForm');
		});
		/* function clp(a) {
			$("#"+a).click();
		} */
		function fileupload(b) {
			$.ajaxFileUpload({
				url : "../taskHandle/baseResUpload.html",
				type : 'POST',
				secureuri : false,
				fileElementId :"baseRes", // 上传文件的id、name属性名
				dataType : 'text',
				cache : false,
				timeout : 300000,
				error : function(e) {
 					layer.msg("上传失败")
 				},
				success : function(result) {
					var objResult = eval('('+result+')');          	
           			var resultCode = objResult.resultCode;
           			var data =  objResult.returnObject;   
					if(resultCode==1000){
							$("#baseResPath").val(data.fileUrl);
							$("#baseResPath2").val(data.fileUrl);
							$("#baseResPath2").show();
							layer.msg("上传成功");
							
					}else{
						layer.msg("上传失败");
					}
				}
			});
		};
		function downloadMoudle(){
			var resType=$("#resType").val();
			if(resType==2){
				window.open("${request.contextPath}/fileMoudel/magMoudle.xlsx");
			}else{
				var a=$("#dataType").val();
				if(a==1||a==6||a==7){
					window.open("${request.contextPath}/fileMoudel/bookMoudle.xlsx");
				}else if(a==2){
					window.open("${request.contextPath}/fileMoudel/bookMoudle.xlsx");
				}else if(a==3){
					window.open("${request.contextPath}/fileMoudel/imgsMoudle.xlsx");
				}else if(a==4){
					window.open("${request.contextPath}/fileMoudel/audioMoudle.xlsx");
				}else if(a==5){
					window.open("${request.contextPath}/fileMoudel/videoMoudle.xlsx");
				}
			}
			
		};
		$("#start").click(function(){
		var flag = confirm('是否确认开始元数据导入？');
		if(flag==true){
			/* $("#dataType").val($("#dataType2").val()); */
			$("#createForm").ajaxSubmit(function(result){
				if(result.code=200){
					var items=result.data;
					var html="";
					if(items.length>0){
						$("#errorBtn").show();
					}else{
						$("#errorBtn").hide();
					}
					$.each(items,function(i){
				    		html+='<tr class="text-c"><td>'+items[i].nlcBookId+'</td><td>'+items[i].name+'</td><td>导入失败</td><td>'+items[i].errorImportReason+'</td></tr>'
				    	})
				    	$("#dataContent").html(html);
				    layer.msg("元数据导入完成！");
				}
			}) 
		}
		});
		$(".layui-layer-close").click(function(){
			backToList();
		})
		function backToList(){
			parent.location.reload();
		}
		//导出excel
		function exportTable(){
        	var filename="导入失败的元数据";
			if (!!window.ActiveXObject || "ActiveXObject" in window){
				getXlsFromTbl('myTable',filename,null);
			} else {
				$("#myTable").table2excel({
					name: "sheet1",
					filename: filename
				});
			}
		}
	</script>
@};
@include("/layout/layout.html",{head:head,content:content,js:js}){}